# Jenkins ❤️ Google Cloud with Workload Identity Federation

[![Badge: Google Cloud](https://img.shields.io/badge/Google%20Cloud-%234285F4.svg?logo=google-cloud&logoColor=white)](https://cloud.google.com/iam/docs/workload-identity-federation)
[![Badge: Jenkins](https://img.shields.io/badge/Jenkins-D24939.svg?logo=jenkins&logoColor=white)](https://www.jenkins.io/)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

This repository provides a blueprint and example for running Jenkins with access to Google Cloud Platform (GCP) utilizing Docker or Podman. It comes pre-configured with the [OpenID Connect Provider plugin](https://plugins.jenkins.io/oidc-provider/) to help you set up secure authentication with GCP services through [Workload Identity Federation](https://cloud.google.com/iam/docs/workload-identity-federation).

This setup allows your Jenkins jobs to securely access Google Cloud resources without the need for long-lived service account keys.

## Prerequisites

Before you begin, ensure you have one of the following container runtimes installed:

*   [Docker](https://docs.docker.com/get-started/get-docker/) with [Docker Compose](https://docs.docker.com/compose/install/), or
*   [Podman](https://podman.io/docs/installation) with [Podman Compose](https://github.com/containers/podman-compose)

You will also need:

*   [Google Cloud CLI](https://cloud.google.com/sdk/docs/install)
*   [Terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli) (for infrastructure as code)

## Getting Started

### 1. Clone the Repository

```bash
git clone https://github.com/Cyclenerd/gcp-jenkins.git
cd gcp-jenkins
```

### 2. Start Jenkins

Launch the Jenkins container using your preferred container runtime:

**With Docker:**

```bash
docker-compose up -d
```

**With Podman:**

```bash
podman-compose up -d
```

Once started, you can access the Jenkins UI at [http://jenkins.localhost:2529](http://jenkins.localhost:2529).

### 3. Configure Workload Identity Federation

To allow Jenkins to authenticate with Google Cloud, you need to configure Workload Identity Federation:

#### Retrieve the JWKS URI

![Screenshot: Jenkins OIDC](./img/jenkins-oidc.png)

The JSON Web Key Set (JWKS) is available at:

```text
http://jenkins.localhost:2529/manage/descriptorByName/io.jenkins.plugins.oidc_provider.IdTokenFileCredentials/jwks?id=jenkins-id-token&issuer=https://jenkins.localhost
```

Store it as `jenkins-jwk.json` in this directory.

curl command to download the JWK file:

```bash
curl -o "jenkins-jwk.json" \
"http://jenkins.localhost:2529/manage/descriptorByName/io.jenkins.plugins.oidc_provider.IdTokenFileCredentials/jwks?id=jenkins-id-token&issuer=https://jenkins.localhost"
```

> [!IMPORTANT]
> To prevent a new key from being created each time the Cointainer is restarted, the file `jasc/credentials.yml` must now be renamed to `jasc/credentials.yml.NOT-ACTIVE`.

#### Create your Workload Identity Pool and Provider

Use the JWKS from the previous step to configure a Workload Identity Pool and Provider in your GCP project.
You can do this by using Terraform.

```bash
terraform init
terraform apply
```

#### Adjust Jenkins Build

Adjust the configuration of the Jenkins pipeline build job "GCP Storage Test" (`http://jenkins.localhost:2529/job/gcp-test-bucket/`).

Change the variables and replace it with the values from the Terraform output.

![Screenshot: Terraform Output](./img/terraform-output.png)

![Screenshot: Jenkins Pipeline](./img/jenkins-pipeline.png)

## Usage

The included `docker-compose.yml` provides commands for managing your Jenkins instance:

*   **Stop Jenkins:**
    ```bash
    # With Docker
    docker-compose stop

    # With Podman
    podman-compose stop
    ```

*   **Start Jenkins:**
    ```bash
    # With Docker
    docker-compose start

    # With Podman
    podman-compose start
    ```

*   **Stop and Remove Containers:**
    ```bash
    # With Docker
    docker-compose down

    # With Podman
    podman-compose down
    ```

### Example OIDC Token

Here is an example of the OIDC token generated by Jenkins:

```json
{
  "iss": "https://jenkins.localhost",
  "aud": "https://jenkins.localhost",
  "exp": 1758922421,
  "iat": 1758918821,
  "sub": "http://jenkins.localhost:2529/job/gcp-test-bucket/",
  "build_number": 1
}
```

## Contributing

Contributions are welcome! Please feel free to submit a pull request or open an issue.

## License

This project is licensed under the Apache 2.0 License - see the [LICENSE](LICENSE) file for details.
